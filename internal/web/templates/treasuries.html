<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasuries - Wheeler</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="treasuries-page">
    <div class="app-container">
        <!-- Sidebar -->
        {{template "_navigation.html" .}}
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Treasury Analytics Panel -->
            <div style="background: #1a1a1a; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); border: 1px solid #404040;">
                <!-- Summary Metrics -->
                <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; width: 50%; justify-content: space-around; align-items: center;">
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 11px; color: #808080; text-transform: uppercase;">Total Interest Earned</div>
                            <div style="font-size: 16px; color: #4ade80; font-weight: 700;">${{printf "%.2f" .Summary.TotalInterest}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 11px; color: #808080; text-transform: uppercase;">Average Return</div>
                            <div style="font-size: 16px; color: #e0e0e0; font-weight: 700;">{{printf "%.2f" .Summary.AverageReturn}}%</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 11px; color: #808080; text-transform: uppercase;">Currently Held</div>
                            <div style="font-size: 16px; color: #e0e0e0; font-weight: 700;">${{printf "%.2f" .Summary.TotalBuyPrice}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 11px; color: #808080; text-transform: uppercase;">Active Positions</div>
                            <div style="font-size: 16px; color: #e0e0e0; font-weight: 700;">{{.Summary.ActivePositions}}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center;">
                            <div style="font-size: 11px; color: #808080; text-transform: uppercase;">Average Duration</div>
                            <div style="font-size: 16px; color: #e0e0e0; font-weight: 700;">{{.Summary.AverageDuration}} days</div>
                        </div>
                    </div>
                </div>

                <!-- Charts: Bonds/Puts (40%), Leverage Over Time (40%), Current Leverage Gauge (20%) -->
                <div style="display: flex; gap: 15px;">
                    <!-- Bonds Held Chart Panel (40% width) -->
                    <div style="background: #2a2a2a; border-radius: 8px; padding: 15px; flex: 0 0 40%; width: 40%; border: 1px solid #404040;">
                        <div style="height: 200px;">
                            <canvas id="bondsHeldChart"></canvas>
                        </div>
                    </div>

                    <!-- Leverage Over Time Chart Panel (40% width) -->
                    <div style="background: #2a2a2a; border-radius: 8px; padding: 15px; flex: 0 0 40%; width: 40%; border: 1px solid #404040;">
                        <div style="height: 200px;">
                            <canvas id="leverageTimeChart"></canvas>
                        </div>
                    </div>

                    <!-- Leverage Gauge Panel (20% width) -->
                    <div style="background: #2a2a2a; border-radius: 8px; padding: 15px; flex: 0 0 calc(20% - 30px); width: calc(20% - 30px); border: 1px solid #404040;">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                            <div style="font-size: 14px; color: #808080; text-transform: uppercase; margin-bottom: 10px;">Current Leverage</div>
                            <div style="height: 180px; width: 100%; display: flex; align-items: center; justify-content: center;">
                                <canvas id="leverageGauge"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Treasuries Table -->
            <div class="content-section">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="openAddModal()">
                        <i class="fas fa-plus"></i>
                        New Treasury
                    </button>
                </div>
                
                <div class="table-container">

                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>CUSPID</th>
                                <th>Purchased</th>
                                <th>Maturity Date</th>
                                <th>Remaining</th>
                                <th class="text-right">Amount</th>
                                <th class="text-right">Yield</th>
                                <th class="text-right">Buy Price</th>
                                <th class="text-right">Current Value</th>
                                <th class="text-right">Exit Price</th>
                                <th class="text-right">Profit/Loss</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Treasuries}}
                            <tr>
                                <td><strong>{{.CUSPID}}</strong></td>
                                <td>{{.Purchased.Format "1/2/2006"}}</td>
                                <td>{{.Maturity.Format "1/2/2006"}}</td>
                                <td>
                                    {{if not .HasExitPrice}}
                                        <span class="{{if le .CalculateDaysRemaining 0}}dte-expired{{else if le .CalculateDaysRemaining 3}}dte-critical{{else if le .CalculateDaysRemaining 6}}dte-warning{{else if le .CalculateDaysRemaining 9}}dte-caution{{else if le .CalculateDaysRemaining 15}}dte-neutral{{else if le .CalculateDaysRemaining 21}}dte-safe{{else}}dte-healthy{{end}}">{{.CalculateDaysRemaining}} days</span>
                                    {{else}}
                                        -
                                    {{end}}
                                </td>
                                <td class="text-right">${{printf "%.2f" .Amount}}</td>
                                <td class="text-right">{{printf "%.3f" .Yield}}%</td>
                                <td class="text-right">${{printf "%.2f" .BuyPrice}}</td>
                                <td class="text-right">{{if .HasCurrentValue}}${{printf "%.2f" .GetCurrentValue}}{{else}}-{{end}}</td>
                                <td class="text-right">{{if .HasExitPrice}}${{printf "%.2f" .GetExitPrice}}{{else}}-{{end}}</td>
                                <td class="text-right">${{printf "%.2f" (.CalculateProfitLoss)}}</td>
                                <td class="text-center">
                                    <div class="row-actions">
                                        <button class="actions-toggle">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <div class="actions-menu">
                                            <button onclick="editTreasury('{{.CUSPID}}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="delete-action" onclick="deleteTreasury('{{.CUSPID}}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="11" style="text-align: center; color: #a0a0a0; padding: 40px;">
                                    No treasuries found. <a href="#" onclick="openAddModal()" style="color: #4fc3f7;">Add your first treasury</a>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                        <tfoot>
                            {{if .Treasuries}}
                            <tr class="table-totals-row">
                                <td colspan="7"><strong>Total</strong></td>
                                <td colspan="2"></td>
                                <td class="text-right"><strong>${{printf "%.2f" .Summary.TotalProfitLoss}}</strong></td>
                                <td></td>
                            </tr>
                            {{end}}
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Treasury Modal -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Treasury</div>
                <span class="close" onclick="closeAddModal()">&times;</span>
            </div>
            <form id="addForm">
                <div class="form-group">
                    <label class="form-label">CUSPID</label>
                    <input type="text" id="addCuspid" class="form-input" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Purchased Date</label>
                        <input type="date" id="addPurchased" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Maturity Date</label>
                        <input type="date" id="addMaturity" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" id="addAmount" class="form-input" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Yield (%)</label>
                        <input type="number" id="addYield" class="form-input" step="0.001" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Buy Price ($)</label>
                        <input type="number" id="addBuyPrice" class="form-input" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Value ($)</label>
                        <input type="number" id="addCurrentValue" class="form-input" step="0.01" placeholder="Optional" onfocus="defaultCurrentValueToBuyPrice()">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Exit Price ($)</label>
                    <input type="number" id="addExitPrice" class="form-input" step="0.01" placeholder="Optional">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Treasury</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Treasury Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Treasury</div>
                <span class="close">&times;</span>
            </div>
            <form id="editForm">
                <div class="form-group">
                    <label class="form-label">CUSPID</label>
                    <input type="text" id="editCuspid" class="form-input" readonly>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Purchased Date</label>
                        <input type="date" id="editPurchased" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Maturity Date</label>
                        <input type="date" id="editMaturity" class="form-input">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Amount ($)</label>
                        <input type="number" id="editAmount" class="form-input" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Yield (%)</label>
                        <input type="number" id="editYield" class="form-input" step="0.001">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Buy Price ($)</label>
                        <input type="number" id="editBuyPrice" class="form-input" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Value ($)</label>
                        <input type="number" id="editCurrentValue" class="form-input" step="0.01">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Exit Price ($)</label>
                    <input type="number" id="editExitPrice" class="form-input" step="0.01" placeholder="Optional">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Confirm Action</div>
                <span class="close" onclick="closeConfirmModal()">&times;</span>
            </div>
            <div id="confirmMessage" style="padding: 20px; font-size: 16px;"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmButton">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Error</div>
                <span class="close" onclick="closeErrorModal()">&times;</span>
            </div>
            <div id="errorMessage" style="padding: 20px; font-size: 16px; color: #ff6b6b;"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeErrorModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Include Shared Symbol Modal -->
    {{template "_symbol_modal.html"}}

    <script>
        // Treasury data for editing (generated from server data)
        const treasuries = {
            {{range $index, $treasury := .Treasuries}}
            '{{$treasury.CUSPID}}': {
                cuspid: '{{$treasury.CUSPID}}',
                purchased: '{{$treasury.Purchased.Format "2006-01-02"}}',
                maturity: '{{$treasury.Maturity.Format "2006-01-02"}}',
                amount: {{$treasury.Amount}},
                yield: {{$treasury.Yield}},
                buyPrice: {{$treasury.BuyPrice}},
                currentValue: {{if $treasury.HasCurrentValue}}{{$treasury.GetCurrentValue}}{{else}}null{{end}},
                exitPrice: {{if $treasury.HasExitPrice}}{{$treasury.GetExitPrice}}{{else}}null{{end}}
            },
            {{end}}
        };

        function editTreasury(cuspid) {
            const treasury = treasuries[cuspid];
            if (!treasury) return;

            // Populate form fields
            document.getElementById('editCuspid').value = treasury.cuspid;
            document.getElementById('editPurchased').value = treasury.purchased;
            document.getElementById('editMaturity').value = treasury.maturity;
            document.getElementById('editAmount').value = treasury.amount;
            document.getElementById('editYield').value = treasury.yield;
            document.getElementById('editBuyPrice').value = treasury.buyPrice;
            document.getElementById('editCurrentValue').value = treasury.currentValue || '';
            document.getElementById('editExitPrice').value = treasury.exitPrice || '';

            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }

        function deleteTreasury(cuspid) {
            const treasury = treasuries[cuspid];
            if (!treasury) return;

            // Show confirmation modal
            showConfirmModal(`Are you sure you want to delete treasury ${cuspid}?`, function() {
                // Send DELETE request to server
                performDelete(cuspid);
            });
        }
        
        function performDelete(cuspid) {
            // Send DELETE request to server
            fetch(`/api/treasuries/${cuspid}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to delete treasury');
            })
            .then(data => {
                console.log('Treasury deleted successfully:', data);
                
                // Remove from local data
                delete treasuries[cuspid];
                
                // Refresh the page to show updated data
                location.reload();
            })
            .catch(error => {
                console.error('Error deleting treasury:', error);
                showErrorModal('Failed to delete treasury. Please try again.');
            });
        }

        function openAddModal() {
            // Clear form fields
            document.getElementById('addForm').reset();
            document.getElementById('addModal').style.display = 'block';
        }

        function closeAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addModal');
            const editModal = document.getElementById('editModal');
            if (event.target === addModal) {
                addModal.style.display = 'none';
            }
            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
        }

        // Close modal with X buttons
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = function() {
                closeAddModal();
                closeModal();
            };
        });

        // Handle add form submission
        document.getElementById('addForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('cuspid', document.getElementById('addCuspid').value);
            formData.append('purchased', document.getElementById('addPurchased').value);
            formData.append('maturity', document.getElementById('addMaturity').value);
            formData.append('amount', document.getElementById('addAmount').value);
            formData.append('yield', document.getElementById('addYield').value);
            formData.append('buyPrice', document.getElementById('addBuyPrice').value);
            formData.append('currentValue', document.getElementById('addCurrentValue').value);
            formData.append('exitPrice', document.getElementById('addExitPrice').value);

            // Submit to backend
            fetch('/add-treasury', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    closeAddModal();
                    location.reload();
                } else {
                    showErrorModal('Error adding treasury. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorModal('Error adding treasury. Please try again.');
            });
        });

        // Handle edit form submission
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const cuspid = document.getElementById('editCuspid').value;
            const formData = {
                purchased: document.getElementById('editPurchased').value,
                maturity: document.getElementById('editMaturity').value,
                amount: parseFloat(document.getElementById('editAmount').value),
                yield: parseFloat(document.getElementById('editYield').value),
                buyPrice: parseFloat(document.getElementById('editBuyPrice').value),
                currentValue: parseFloat(document.getElementById('editCurrentValue').value) || null,
                exitPrice: parseFloat(document.getElementById('editExitPrice').value) || null
            };

            // Send to server via PUT request
            fetch(`/api/treasuries/${cuspid}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to update treasury');
            })
            .then(data => {
                console.log('Treasury updated successfully:', data);
                
                // Update local data
                treasuries[cuspid] = {
                    cuspid: data.cuspid,
                    purchased: data.purchased.split('T')[0], // Convert ISO date to YYYY-MM-DD
                    maturity: data.maturity.split('T')[0],
                    amount: data.amount,
                    yield: data.yield,
                    buyPrice: data.buy_price,
                    currentValue: data.current_value,
                    exitPrice: data.exit_price
                };
                
                // Close modal
                closeModal();
                
                // Refresh the page to show updated data
                location.reload();
            })
            .catch(error => {
                console.error('Error updating treasury:', error);
                showErrorModal('Failed to update treasury. Please try again.');
            });
        });

        console.log('Treasuries page loaded with edit functionality');
        
        // Symbol Modal functionality is handled by shared module
        
        // Default Current Value to Buy Price when focused and empty
        function defaultCurrentValueToBuyPrice() {
            const currentValueInput = document.getElementById('addCurrentValue');
            const buyPriceInput = document.getElementById('addBuyPrice');
            
            if (!currentValueInput.value && buyPriceInput.value) {
                currentValueInput.value = buyPriceInput.value;
            }
        }
        
        // Confirmation Modal Functions
        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'block';
            
            // Set up confirm button click handler
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.onclick = function() {
                closeConfirmModal();
                onConfirm();
            };
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }
        
        // Error Modal Functions
        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'block';
        }
        
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const confirmModal = document.getElementById('confirmModal');
            const errorModal = document.getElementById('errorModal');
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
            if (event.target === errorModal) {
                closeErrorModal();
            }
        });
        
        // Bonds Held Over Time Chart
        $(document).ready(function() {
            // Build daily bonds held data for the past year
            const bondsHeldByDate = {};
            const putExposureByDate = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Start date: 365 days ago
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 365);
            
            // Collect all treasury positions
            const treasuryPositions = [];
            {{range .Treasuries}}
                {
                    const purchased = new Date('{{.Purchased.Format "2006-01-02"}}');
                    const maturity = new Date('{{.Maturity.Format "2006-01-02"}}');
                    const exitDate = {{if .HasExitPrice}}new Date('{{.Maturity.Format "2006-01-02"}}'){{else}}null{{end}};
                    const buyPrice = {{.BuyPrice}};
                    
                    treasuryPositions.push({
                        purchased: purchased,
                        maturity: maturity,
                        exitDate: exitDate,
                        buyPrice: buyPrice
                    });
                }
            {{end}}
            
            // Collect all put options
            const putOptions = [];
            {{range .Options}}
                {{if eq .Type "Put"}}
                    {
                        const opened = new Date('{{.Opened.Format "2006-01-02"}}');
                        const expiration = new Date('{{.Expiration.Format "2006-01-02"}}');
                        const closed = {{if .Closed}}new Date('{{.Closed.Format "2006-01-02"}}'){{else}}null{{end}};
                        const exposure = {{.Strike}} * {{.Contracts}} * 100;
                        
                        putOptions.push({
                            opened: opened,
                            expiration: expiration,
                            closed: closed,
                            exposure: exposure
                        });
                    }
                {{end}}
            {{end}}
            
            // Calculate total bonds held and put exposure for each day
            let currentDate = new Date(startDate);
            while (currentDate <= today) {
                const dateStr = currentDate.toISOString().split('T')[0];
                let totalHeld = 0;
                let totalPutExposure = 0;
                
                treasuryPositions.forEach(position => {
                    const isActive = currentDate >= position.purchased && 
                                   currentDate <= position.maturity &&
                                   (!position.exitDate || currentDate < position.exitDate);
                    if (isActive) {
                        totalHeld += position.buyPrice;
                    }
                });
                
                putOptions.forEach(put => {
                    const isActive = currentDate >= put.opened && 
                                   currentDate <= put.expiration &&
                                   (!put.closed || currentDate < put.closed);
                    if (isActive) {
                        totalPutExposure += put.exposure;
                    }
                });
                
                bondsHeldByDate[dateStr] = totalHeld;
                putExposureByDate[dateStr] = totalPutExposure;
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Prepare chart data
            const labels = Object.keys(bondsHeldByDate);
            const bondsData = labels.map(date => bondsHeldByDate[date]);
            const putExposureData = labels.map(date => putExposureByDate[date]);
            
            // Calculate leverage: Put Exposure / Bonds Held
            const leverageData = labels.map(date => {
                const bonds = bondsHeldByDate[date];
                const puts = putExposureByDate[date];
                return bonds > 0 ? puts / bonds : 0;
            });
            
            // Create chart with dual Y-axis
            const ctx = document.getElementById('bondsHeldChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(dateStr => {
                        const date = new Date(dateStr);
                        return (date.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                               date.getDate().toString().padStart(2, '0');
                    }),
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Put Exposure',
                            data: putExposureData,
                            backgroundColor: 'rgba(52, 152, 219, 0.6)',
                            borderColor: '#3498db',
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            type: 'bar',
                            label: 'Bonds Held',
                            data: bondsData,
                            backgroundColor: 'rgba(255, 193, 7, 0.9)',
                            borderColor: '#FFC107',
                            borderWidth: 1,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#a0a0a0',
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 52
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                color: '#a0a0a0',
                                font: { size: 10 },
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e0e0e0',
                                font: { size: 11 },
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '$' + context.parsed.y.toLocaleString();
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Create leverage over time chart
            const leverageTimeCtx = document.getElementById('leverageTimeChart').getContext('2d');
            new Chart(leverageTimeCtx, {
                type: 'line',
                data: {
                    labels: labels.map(dateStr => {
                        const date = new Date(dateStr);
                        return (date.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                               date.getDate().toString().padStart(2, '0');
                    }),
                    datasets: [{
                        label: 'Leverage',
                        data: leverageData,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#a0a0a0',
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 52
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            min: 0,
                            ticks: {
                                color: '#a0a0a0',
                                font: { size: 10 },
                                callback: function(value) {
                                    return value.toFixed(1) + 'x';
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#e0e0e0',
                                font: { size: 11 },
                                padding: 10,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Leverage: ' + context.parsed.y.toFixed(2) + 'x';
                                }
                            }
                        }
                    }
                }
            });
            
            // Create leverage gauge styled like the reference
            const currentLeverage = leverageData[leverageData.length - 1] || 0;
            const gaugeCtx = document.getElementById('leverageGauge').getContext('2d');
            
            // Define color ranges
            const ranges = [
                { limit: 0.5, color: '#27ae60' },   // Green
                { limit: 1.0, color: '#ffeb3b' },   // Yellow
                { limit: 1.5, color: '#ff9800' },   // Orange
                { limit: 2.0, color: '#e74c3c' }    // Red
            ];
            
            const gaugeChart = new Chart(gaugeCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [0.5, 0.5, 0.5, 0.5],
                        backgroundColor: ranges.map(r => r.color),
                        borderWidth: 2,
                        borderColor: '#1a1a1a',
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    animation: {
                        onComplete: function() {
                            drawNeedle(this);
                        }
                    }
                },
                plugins: [{
                    id: 'gaugeNeedle',
                    afterDatasetDraw: function(chart) {
                        drawNeedle(chart);
                    }
                }]
            });
            
            function drawNeedle(chart) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                const centerX = (chartArea.left + chartArea.right) / 2;
                const centerY = chartArea.bottom;
                
                // Calculate needle angle (0 to 180 degrees for 0 to 2x leverage)
                const needleValue = Math.min(Math.max(currentLeverage, 0), 2);
                const angle = (needleValue / 2) * Math.PI - Math.PI / 2;
                
                // Needle dimensions based on chart area
                const radius = (chartArea.bottom - chartArea.top);
                const needleLength = radius * 0.70;
                const needleWidth = 6;
                const hubRadius = 12;
                
                ctx.save();
                
                // Draw needle
                ctx.translate(centerX, centerY);
                ctx.rotate(angle);
                
                ctx.beginPath();
                ctx.moveTo(-needleWidth / 2, 0);
                ctx.lineTo(0, -needleLength);
                ctx.lineTo(needleWidth / 2, 0);
                ctx.closePath();
                ctx.fillStyle = '#d0d0d0';
                ctx.fill();
                ctx.strokeStyle = '#808080';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                ctx.restore();
                
                // Draw hub circle
                ctx.beginPath();
                ctx.arc(centerX, centerY, hubRadius, 0, Math.PI * 2);
                ctx.fillStyle = '#d0d0d0';
                ctx.fill();
                ctx.strokeStyle = '#808080';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Draw value label
                ctx.font = 'bold 28px Arial';
                ctx.fillStyle = '#e0e0e0';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(currentLeverage.toFixed(2) + 'x', centerX, centerY - radius * 0.3);
            }
        });
    </script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/symbol-modal.js"></script>
    <script src="/static/js/table-sort.js"></script>
    <script src="/static/js/row-actions.js"></script>

</body>
</html>