<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Wheeler</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <style>
        /* Dashboard-specific layout overrides */
        .dashboard-page .main-content {
            overflow-y: hidden !important; /* Prevent double scrolling */
        }
        
        .dashboard-page .content-section:last-child {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            min-height: 0 !important;
        }
        
        .dashboard-page .content-section:last-child .section-title {
            flex-shrink: 0 !important;
        }
        
        .dashboard-page .table-container-scrollable {
            flex: 1 !important;
            min-height: 0 !important;
            height: auto !important;
            max-height: none !important;
            overflow-y: auto !important;
            overflow-x: auto !important;
            border: 1px solid #404040 !important;
            background-color: #2d2d2d !important;
        }
        
        .dashboard-page .table-container-scrollable table {
            min-width: 1000px;
            background-color: transparent !important;
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="app-container">
        <!-- Sidebar -->
        {{template "_navigation.html" .}}
        
        <!-- Main Content -->
        <div class="main-content" style="display: flex; flex-direction: column; height: calc(100vh - 40px);">
            
            <!-- Dashboard Totals Panel -->
            <div class="content-section" style="margin-bottom: 20px; flex-shrink: 0;">
                <div style="background: #2d2d2d; padding: 15px; border-radius: 8px; border: 1px solid #404040; text-align: center; font-size: 20px;">
                    <span style="color: #a0a0a0;">Nominal Total:</span> <span id="nominalTotal" style="color: #27ae60;">$0</span>
                    <span style="color: #888; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;Open Options: <span id="openOptions" style="color: #27ae60;">$0</span> / <span id="openOptionsPercent" style="color: #27ae60;">0.0%</span> of Nominal</span>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <span style="color: #a0a0a0;">Long:</span> <span id="totalLong" style="color: #27ae60;">$0</span>
                    <span style="color: #888; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;Open Calls: <span id="callPremiums" style="color: #27ae60;">$0</span> / <span id="longROI" style="color: #27ae60;">0.0%</span> of Long</span>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <span style="color: #a0a0a0;">Puts:</span> <span id="totalPuts" style="color: #27ae60;">$0</span>
                    <span style="color: #888; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;Open Puts: <span id="putPremiums" style="color: #27ae60;">$0</span> / <span id="putROI" style="color: #27ae60;">0.0%</span> of Exposure / <span id="putsOfTreasuries" style="color: #27ae60;">0.0%</span> of Treasuries</span>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    <span style="color: #a0a0a0;">Treasuries:</span> <span id="totalTreasuries" style="color: #27ae60;">$0</span>
                </div>
            </div>
            
            <!-- Charts Container -->
            <div class="content-section" style="margin-bottom: 20px; flex-shrink: 0;">
                <div class="charts-section">
                    <!-- Long Stock by Symbol -->
                    <div class="chart-container">
                        <div class="chart-title">Long Value</div>
                        <canvas id="longByTickerChart" class="chart-canvas"></canvas>
                    </div>
                    
                    <!-- Put Exposure by Symbol -->
                    <div class="chart-container">
                        <div class="chart-title">Put Exposure</div>
                        <canvas id="putsByTickerChart" class="chart-canvas"></canvas>
                    </div>
                    
                    <!-- Total Allocation -->
                    <div class="chart-container">
                        <div class="chart-title">Overall Allocation</div>
                        <canvas id="totalAllocationChart" class="chart-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Watchlist Summary Table -->
            <div class="content-section">
                <div class="section-title">Watchlist Summary</div>
                <div class="table-container-scrollable">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Long</th>
                                <th>Put Exposed</th>
                                <th>Optionable</th>
                                <th>Puts</th>
                                <th>Calls</th>
                                <th>Cap Gains</th>
                                <th>Dividends</th>
                                <th>Net</th>
                                <th>CoC%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{if .SymbolSummaries}}
                                {{range .SymbolSummaries}}
                                <tr>
                                    <td class="ticker-col"><a href="/symbol/{{.Ticker}}" class="symbol-link">{{.Ticker}}</a></td>
                                    <td>{{formatCurrency .LongAmount}}</td>
                                    <td>{{formatCurrency .PutExposed}}</td>
                                    <td>{{formatCurrency .Optionable}}</td>
                                    <td class="{{if lt .Puts 0.0}}negative{{else if gt .Puts 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Puts}}</td>
                                    <td class="{{if lt .Calls 0.0}}negative{{else if gt .Calls 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Calls}}</td>
                                    <td class="{{if lt .CapGains 0.0}}negative{{else if gt .CapGains 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .CapGains}}</td>
                                    <td class="{{if lt .Dividends 0.0}}negative{{else if gt .Dividends 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Dividends}}</td>
                                    <td class="{{if lt .Net 0.0}}negative{{else if gt .Net 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Net}}</td>
                                    <td class="{{if lt .CashOnCash 0.0}}negative{{else if gt .CashOnCash 0.0}}positive{{end}}">{{printf "%.2f" .CashOnCash}}%</td>
                                </tr>
                                {{end}}
                            {{else}}
                                <tr>
                                    <td colspan="10" style="text-align: center; color: #a0a0a0; padding: 20px;">
                                        No portfolio data available
                                    </td>
                                </tr>
                            {{end}}
                        </tbody>
                        <tfoot>
                            <tr class="table-totals-row">
                                <td class="ticker-col">Total</td>
                                <td>{{formatCurrency .Totals.TotalLong}}</td>
                                <td>{{formatCurrency .Totals.TotalPuts}}</td>
                                <td>{{formatCurrency .Totals.TotalOptionable}}</td>
                                <td class="{{if lt .Totals.TotalPutPremiums 0.0}}negative{{else if gt .Totals.TotalPutPremiums 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Totals.TotalPutPremiums}}</td>
                                <td class="{{if lt .Totals.TotalCallPremiums 0.0}}negative{{else if gt .Totals.TotalCallPremiums 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Totals.TotalCallPremiums}}</td>
                                <td class="{{if lt .Totals.TotalCapGains 0.0}}negative{{else if gt .Totals.TotalCapGains 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Totals.TotalCapGains}}</td>
                                <td class="{{if lt .Totals.TotalDividends 0.0}}negative{{else if gt .Totals.TotalDividends 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Totals.TotalDividends}}</td>
                                <td class="{{if lt .Totals.OverallCashOnCash 0.0}}negative{{else if gt .Totals.OverallCashOnCash 0.0}}positive{{end}}">{{formatCurrencyWithDecimals .Totals.TotalNet}}</td>
                                <td class="{{if lt .Totals.OverallCashOnCash 0.0}}negative{{else if gt .Totals.OverallCashOnCash 0.0}}positive{{end}}">{{printf "%.2f" .Totals.OverallCashOnCash}}%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Shared Symbol Modal -->
    {{template "_symbol_modal.html"}}

    <script>
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        // Dynamic chart data from backend
        const longByTickerData = [
            {{range $index, $data := .LongByTicker}}
            {{if $index}},{{end}}
            {label: '{{$data.Label}}', value: {{$data.Value}}}
            {{end}}
        ];
        
        const putsByTickerData = [
            {{range $index, $data := .PutsByTicker}}
            {{if $index}},{{end}}
            {label: '{{$data.Label}}', value: {{$data.Value}}}
            {{end}}
        ];

        // This will be populated with real data from the API
        let totalAllocationData = [
            {label: 'Long Stock', value: 0, color: '#36A2EB'},
            {label: 'Put Exposure', value: 0, color: '#FF6384'},
            {label: 'Treasuries', value: 0, color: '#FFCE56'}
        ];

        // Chart colors - standardized palette matching Monthly view
        const chartColors = [
            '#3498db',  // Blue
            '#e67e22',  // Orange
            '#27ae60',  // Green
            '#e74c3c',  // Red
            '#f39c12',  // Yellow/Gold
            '#9b59b6',  // Purple
            '#1abc9c',  // Turquoise
            '#34495e',  // Dark Blue-Grey
            '#16a085',  // Dark Turquoise
            '#c0392b',  // Dark Red
            '#d35400',  // Dark Orange
            '#8e44ad'   // Dark Purple
        ];
        
        // Get unique symbols from both charts and sort alphabetically
        const allSymbols = new Set();
        longByTickerData.forEach(item => allSymbols.add(item.label));
        putsByTickerData.forEach(item => allSymbols.add(item.label));
        const sortedSymbols = Array.from(allSymbols).sort();
        
        // Function to get consistent color for a symbol
        function getSymbolColor(symbol) {
            const index = sortedSymbols.indexOf(symbol);
            return chartColors[index % chartColors.length];
        }
        
        // Apply colors to data
        longByTickerData.forEach(item => {
            item.color = getSymbolColor(item.label);
        });
        putsByTickerData.forEach(item => {
            item.color = getSymbolColor(item.label);
        });

        // Chart configuration
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false
            },
            animation: {
                duration: 750
            },
            plugins: {
                legend: {
                    position: 'right',
                    align: 'start',
                    maxWidth: 200,
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 14
                        },
                        padding: 10,
                        color: '#e0e0e0',
                        usePointStyle: true,
                        sort: function(a, b) {
                            // Sort legend items alphabetically
                            return a.text.localeCompare(b.text);
                        }
                    }
                },
                tooltip: {
                    enabled: true,
                    mode: 'nearest',
                    callbacks: {
                        label: function(context) {
                            return context.label + ': $' + context.parsed.toLocaleString();
                        }
                    }
                },
                datalabels: {
                    display: true,
                    color: '#e0e0e0',
                    font: {
                        size: 12,
                        weight: 'bold'
                    },
                    formatter: function(value, context) {
                        if (value < 500) return '';
                        return '$' + Math.round(value).toLocaleString();
                    }
                }
            },
            layout: {
                padding: {
                    top: 10,
                    bottom: 10,
                    left: 10,
                    right: 120
                }
            }
        };

        // Sort data by size (descending) for pie chart display
        const longByTickerSorted = [...longByTickerData].sort((a, b) => b.value - a.value);
        const putsByTickerSorted = [...putsByTickerData].sort((a, b) => b.value - a.value);

        // Long by Ticker Chart
        new Chart(document.getElementById('longByTickerChart'), {
            type: 'pie',
            data: {
                labels: longByTickerSorted.map(item => item.label),
                datasets: [{
                    data: longByTickerSorted.map(item => item.value),
                    backgroundColor: longByTickerSorted.map(item => item.color),
                    borderWidth: 0.5,
                    borderColor: '#666666'
                }]
            },
            plugins: [ChartDataLabels],
            options: chartOptions
        });

        // Puts by Ticker Chart
        new Chart(document.getElementById('putsByTickerChart'), {
            type: 'pie',
            data: {
                labels: putsByTickerSorted.map(item => item.label),
                datasets: [{
                    data: putsByTickerSorted.map(item => item.value),
                    backgroundColor: putsByTickerSorted.map(item => item.color),
                    borderWidth: 0.5,
                    borderColor: '#666666'
                }]
            },
            plugins: [ChartDataLabels],
            options: chartOptions
        });

        // Total Allocation Chart - will be created after data is loaded
        let totalAllocationChart;

        // Function to update Dashboard totals header
        function updateDashboardTotals(data) {
            const nominalTotalElement = document.getElementById('nominalTotal');
            const totalLongElement = document.getElementById('totalLong');
            const totalPutsElement = document.getElementById('totalPuts');
            const totalTreasuriesElement = document.getElementById('totalTreasuries');
            const longROIElement = document.getElementById('longROI');
            const putROIElement = document.getElementById('putROI');
            const callPremiumsElement = document.getElementById('callPremiums');
            const putPremiumsElement = document.getElementById('putPremiums');
            const putsOfTreasuriesElement = document.getElementById('putsOfTreasuries');
            const openOptionsElement = document.getElementById('openOptions');
            const openOptionsPercentElement = document.getElementById('openOptionsPercent');
            
            // Format currency with consistent green coloring
            function formatCurrency(value, element) {
                const formattedValue = '$' + Math.round(Math.abs(value)).toLocaleString();
                if (value < 0) {
                    element.innerHTML = '-' + formattedValue;
                } else {
                    element.innerHTML = formattedValue;
                }
                // Always use green color
                element.style.color = '#27ae60';
            }
            
            // Format percentage values
            function formatPercentage(value, element) {
                const formattedValue = value.toFixed(1) + '%';
                element.innerHTML = formattedValue;
                element.style.color = '#27ae60';
            }
            
            // Extract values from API response or fallback properties
            let totalLong = 0, totalPutExposed = 0, totalTreasuries = 0;
            
            if (data.totalAllocation && Array.isArray(data.totalAllocation)) {
                // Extract values from totalAllocation array
                data.totalAllocation.forEach(item => {
                    if (item.label === 'Long Stock') {
                        totalLong = item.value || 0;
                    } else if (item.label === 'Put Exposure') {
                        totalPutExposed = item.value || 0;
                    } else if (item.label === 'Treasuries') {
                        totalTreasuries = item.value || 0;
                    }
                });
            } else {
                // Fallback for individual properties
                totalLong = data.totalLong || 0;
                totalPutExposed = data.totalPutExposed || 0;
                totalTreasuries = data.totalTreasuries || 0;
            }
            
            // Calculate nominal total (Long + Treasuries)
            const nominalTotalValue = totalLong + totalTreasuries;
            
            // Update each total
            formatCurrency(nominalTotalValue, nominalTotalElement);
            formatCurrency(totalLong, totalLongElement);
            formatCurrency(totalPutExposed, totalPutsElement);
            formatCurrency(totalTreasuries, totalTreasuriesElement);
            
            // Calculate Puts as % of Treasuries (using put premiums, not exposure)
            const putsOfTreasuriesPercent = totalTreasuries > 0 ? ((data.totalPutPremiums || 0) / totalTreasuries) * 100 : 0;
            
            // Calculate Open Options total and percentage of nominal
            const totalOpenOptions = (data.totalCallPremiums || 0) + (data.totalPutPremiums || 0);
            const openOptionsPercent = nominalTotalValue > 0 ? (totalOpenOptions / nominalTotalValue) * 100 : 0;
            
            // Update ROI values and premiums
            formatPercentage(data.longROI || 0, longROIElement);
            formatPercentage(data.putROI || 0, putROIElement);
            formatCurrency(data.totalCallPremiums || 0, callPremiumsElement);
            formatCurrency(data.totalPutPremiums || 0, putPremiumsElement);
            formatPercentage(putsOfTreasuriesPercent, putsOfTreasuriesElement);
            formatCurrency(totalOpenOptions, openOptionsElement);
            formatPercentage(openOptionsPercent, openOptionsPercentElement);
        }

        // Function to create Total Allocation Chart with data
        function createTotalAllocationChart(data) {
            // Check if data has totalAllocation array (from API) or individual properties (fallback)
            if (data.totalAllocation && Array.isArray(data.totalAllocation)) {
                totalAllocationData = data.totalAllocation;
            } else {
                // Fallback for when called with individual properties
                totalAllocationData = [
                    {label: 'Long Stock', value: data.totalLong || 0, color: '#36A2EB'},
                    {label: 'Put Exposure', value: data.totalPutExposed || 0, color: '#FF6384'},
                    {label: 'Treasuries', value: data.totalTreasuries || 0, color: '#FFCE56'}
                ];
            }
            
            // Sort by size (descending) for pie chart display
            const totalAllocationSorted = [...totalAllocationData].sort((a, b) => b.value - a.value);
            
            totalAllocationChart = new Chart(document.getElementById('totalAllocationChart'), {
                type: 'pie',
                data: {
                    labels: totalAllocationSorted.map(item => item.label),
                    datasets: [{
                        data: totalAllocationSorted.map(item => item.value),
                        backgroundColor: totalAllocationSorted.map(item => item.color),
                        borderWidth: 0.5,
                        borderColor: '#666666'
                    }]
                },
                plugins: [ChartDataLabels],
                options: chartOptions
            });
        }

        // Fetch allocation data and create chart
        fetch('/api/allocation-data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch allocation data');
                }
                return response.json();
            })
            .then(data => {
                console.log('Allocation data received:', data);
                createTotalAllocationChart(data);
                updateDashboardTotals(data);
            })
            .catch(error => {
                console.error('Error fetching allocation data:', error);
                // Create chart with zero values if API fails
                const zeroData = {
                    totalLong: 0,
                    totalPutExposed: 0,
                    totalTreasuries: 0
                };
                createTotalAllocationChart(zeroData);
                updateDashboardTotals(zeroData);
            });

        // Symbol Modal functionality is handled by shared module

        // Apply profit/loss coloring and currency formatting to watchlist table
        function applyWatchlistTableColoring() {
            const table = document.querySelector('.financial-table');
            if (!table) return;
            
            // Process all rows in tbody and tfoot
            const rows = table.querySelectorAll('tbody tr, tfoot tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, columnIndex) => {
                    const text = cell.textContent.trim();
                    
                    // Check if it's a monetary value (with or without decimal places)
                    if (text.match(/^-?\$[\d,]*\.?\d*$/)) {
                        // Extract numeric value
                        const value = parseFloat(text.replace(/[\$,]/g, ''));
                        
                        // Skip if it's not a valid number
                        if (isNaN(value)) return;
                        
                        // Format as whole dollars with comma separators
                        const formattedValue = '$' + Math.round(Math.abs(value)).toLocaleString();
                        
                        // Long (column 1), Put Exposed (column 2), and Optionable (column 3) are absolute values - no profit/loss coloring
                        if (columnIndex === 1 || columnIndex === 2 || columnIndex === 3) {
                            cell.innerHTML = formattedValue;
                        }
                        // Other monetary columns get profit/loss coloring
                        else {
                            if (value < 0) {
                                cell.innerHTML = '<span class="negative">-' + formattedValue + '</span>';
                            } else if (value > 0) {
                                cell.innerHTML = '<span class="positive">' + formattedValue + '</span>';
                            } else {
                                cell.innerHTML = formattedValue;
                            }
                        }
                    }
                    
                    // Check if it's a percentage value
                    else if (text.match(/^-?[\d,]+\.\d{2}%$/)) {
                        // Extract numeric value
                        const value = parseFloat(text.replace(/[%,]/g, ''));
                        
                        // Apply coloring: negative percentages are red, positive are green
                        if (value < 0) {
                            cell.innerHTML = '<span class="negative">' + text + '</span>';
                        } else if (value > 0) {
                            cell.innerHTML = '<span class="positive">' + text + '</span>';
                        }
                    }
                });
            });
        }
        
        // Apply coloring when page loads
        document.addEventListener('DOMContentLoaded', applyWatchlistTableColoring);
        // Also apply coloring immediately in case DOMContentLoaded already fired
        applyWatchlistTableColoring();

        console.log('Static dashboard loaded with matching spreadsheet data');
    </script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/symbol-modal.js"></script>
    <script src="/static/js/table-sort.js"></script>

</body>
</html>