<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options - Wheeler</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css?v=2">
    <style>
        /* Options page uses large chart size for detailed visualization */
        .options-page .chart-container {
            height: 400px;
            min-height: 400px;
            max-height: 400px;
        }
        
        /* Highlight effect for symbol navigation */
        .symbol-nav-item.highlighted {
            background-color: #27ae60 !important;
            color: #ffffff !important;
            transform: scale(1.05);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        }
        
        /* 8-column grid layout for accordion headers */
        .accordion-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 0 5px;
        }
        
        .grid-item {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 2px 4px;
        }
        
        .grid-item.span-2 {
            grid-column: span 2;
        }
        
        .grid-item.span-1 {
            grid-column: span 1;
        }
        
        .grid-item.expiration-section {
            color: #e0e0e0;
            font-weight: 700;
            font-size: 14px;
        }
        
        .grid-item.expiration-section i {
            margin-right: 6px;
        }
        
        .grid-item.dte-section {
            color: #a0a0a0;
        }
        
        .grid-item.positions-count {
            color: #e0e0e0;
        }
        
        .grid-item.calls-info {
            color: #e0e0e0;
        }
        
        .grid-item.puts-info {
            color: #e0e0e0;
        }
        
        /* Dynamic panel sizing for Open Positions */
        .options-dynamic-panel {
            display: flex;
            flex-direction: column;
            margin-bottom: 40px;
        }
        
        .options-dynamic-panel .section-title {
            flex-shrink: 0;
            margin-bottom: 20px;
        }
        
        .options-dynamic-panel .accordion-container {
            flex: 1;
            overflow: visible;
        }
        
        /* Sortable table styling */
        .sortable-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .sortable-table th.sortable:hover {
            background-color: #404040;
        }
        
        .sortable-table th.sortable i {
            margin-left: 5px;
            opacity: 0.5;
        }
        
        .sortable-table th.sortable.asc i:before {
            content: "\f0de";
            opacity: 1;
        }
        
        .sortable-table th.sortable.desc i:before {
            content: "\f0dd"; 
            opacity: 1;
        }
        
        /* Status badges */
        .status-open {
            color: #27ae60;
            font-weight: bold;
        }
        
        .status-closed {
            color: #95a5a6;
            font-weight: bold;
        }
        
        .text-muted {
            color: #95a5a6;
            font-style: italic;
        }
    </style>
</head>
<body class="options-page">
    <div class="app-container">
        <!-- Sidebar -->
        {{template "_navigation.html" .}}
        
        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Charts Container -->
            <div class="content-section">
                <div class="charts-wrapper" style="display: flex; gap: 20px;">
                    <!-- Profit by Expiration Date Chart (75%) -->
                    <div style="flex: 3;">
                        <div class="section-title">Options by Expiration</div>
                        <div class="chart-container">
                            <canvas id="expirationScatterChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Put Exposure Pie Chart (25%) -->
                    <div style="flex: 1;">
                        <div class="section-title">Put Exposure</div>
                        <div class="chart-container">
                            <canvas id="putExposurePieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Open Positions Panel with Dynamic Height -->
            <div class="content-section options-dynamic-panel" id="openPositionsPanel">
                <div class="section-title">Open Positions</div>
                <div class="accordion-container">
                    {{if .OpenPositions}}
                        {{$groupedPositions := (.OpenPositions | groupByExpiration)}}
                        {{range $groupedPositions}}
                        <div class="accordion-group">
                            <div class="accordion-header" data-target="exp-{{.DateStr | replace "/" "-"}}">
                                <div class="accordion-grid">
                                    <!-- Expiration: Date (spans 1 div) -->
                                    <div class="grid-item span-1 expiration-section">
                                        <i class="fas fa-calendar-alt"></i>
                                        Expiration: {{.DateStr}}
                                    </div>
                                    {{if .Positions}}
                                        {{$firstPosition := index .Positions 0}}
                                        <!-- DTE: X days (spans 1 div) -->
                                        <div class="grid-item span-1 dte-section">
                                            DTE: <span class="{{if le $firstPosition.DaysToExpiration 0}}dte-expired{{else if le $firstPosition.DaysToExpiration 3}}dte-critical{{else if le $firstPosition.DaysToExpiration 6}}dte-warning{{else if le $firstPosition.DaysToExpiration 9}}dte-caution{{else if le $firstPosition.DaysToExpiration 15}}dte-neutral{{else if le $firstPosition.DaysToExpiration 21}}dte-safe{{else}}dte-healthy{{end}}">{{$firstPosition.DaysToExpiration}} days</span>
                                        </div>
                                        {{$callCount := 0}}
                                        {{$putCount := 0}}
                                        {{$callNominal := 0.0}}
                                        {{$putExposed := 0.0}}
                                        {{$totalPremium := 0.0}}
                                        {{range .Positions}}
                                            {{if eq .Type "Call"}}
                                                {{$callCount = add $callCount 1}}
                                                {{$callNominal = add $callNominal (mul (mul .Strike .Contracts) 100)}}
                                            {{else}}
                                                {{$putCount = add $putCount 1}}
                                                {{$putExposed = add $putExposed (mul (mul .Strike .Contracts) 100)}}
                                            {{end}}
                                            {{$totalPremium = add $totalPremium .CalculateTotalProfit}}
                                        {{end}}
                                        <!-- Positions count (spans 1 div) -->
                                        <div class="grid-item span-1 positions-count">
                                            {{len .Positions}} Position{{if ne (len .Positions) 1}}s{{end}} - {{formatCurrency $totalPremium}} premium
                                        </div>
                                        <!-- Calls info (spans 1 div) -->
                                        <div class="grid-item span-1 calls-info">
                                            {{if gt $callCount 0}}{{$callCount}} Call{{if ne $callCount 1}}s{{end}} - {{formatCurrency $callNominal}}{{end}}
                                        </div>
                                        <!-- Puts info (spans 1 div) -->
                                        <div class="grid-item span-1 puts-info">
                                            {{if gt $putCount 0}}{{$putCount}} Put{{if ne $putCount 1}}s{{end}} - {{formatCurrency $putExposed}}{{end}}
                                        </div>
                                        <!-- Empty divs (spans 3 divs) -->
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                    {{else}}
                                        <!-- If no positions, fill remaining space (7 divs) -->
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                        <div class="grid-item span-1"></div>
                                    {{end}}
                                </div>
                                <div class="accordion-toggle">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <div class="accordion-content" id="exp-{{.DateStr | replace "/" "-"}}">
                                <div class="table-container-scrollable">
                                    <table class="financial-table">
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th>Type</th>
                                                <th>Strike</th>
                                                <th>Quantity</th>
                                                <th>Nominal</th>
                                                <th>Total Profit</th>
                                                <th>Entry Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {{range .Positions}}
                                            <tr>
                                                <td class="ticker-col"><a href="/symbol/{{.Symbol}}?edit_option={{.ID}}" class="symbol-link">{{.Symbol}}</a></td>
                                                <td>
                                                    <span class="{{if eq .Type "Put"}}put-badge{{else}}call-badge{{end}}">
                                                        {{if eq .Type "Put"}}P{{else}}C{{end}}
                                                    </span>
                                                </td>
                                                <td class="neutral-currency">${{printf "%.2f" .Strike}}</td>
                                                <td>{{.Contracts}}</td>
                                                <td class="neutral-currency">{{formatCurrency (mul (mul .Strike .Contracts) 100)}}</td>
                                                <td class="premium-column {{if lt .CalculateTotalProfit 0.0}}negative{{else if gt .CalculateTotalProfit 0.0}}positive{{else}}neutral-currency{{end}}">${{printf "%.2f" .CalculateTotalProfit}}</td>
                                                <td>{{.EntryDate.Format "01/02/2006"}}</td>
                                            </tr>
                                            {{end}}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    {{else}}
                        <div style="text-align: center; color: #a0a0a0; padding: 40px;">
                            <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                            <div style="font-size: 18px; margin-bottom: 10px;">No Open Option Positions</div>
                            <div style="font-size: 14px;">All your option positions have been closed.</div>
                        </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>

    <!-- Include Shared Symbol Modal -->
    {{template "_symbol_modal.html"}}

    <script>
        // Apply profit/loss coloring and formatting to options tables
        function applyOptionsTableColoring() {
            const tables = document.querySelectorAll('.financial-table');
            tables.forEach(table => {
                // Process all rows in tbody and tfoot
                const rows = table.querySelectorAll('tbody tr, tfoot tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, columnIndex) => {
                        const text = cell.textContent.trim();
                        
                        // Skip cells with neutral-currency or premium-column class
                        if (cell.classList.contains('neutral-currency') || cell.classList.contains('premium-column')) {
                            return;
                        }
                        
                        // Check if it's a monetary value (with or without decimal places)
                        if (text.match(/^\$-?[\d,]*\.?\d*$/)) {
                            // Extract numeric value
                            const value = parseFloat(text.replace(/[\$,]/g, ''));
                            
                            // Skip if it's not a valid number
                            if (isNaN(value)) return;
                            
                            // Format as currency with comma separators
                            const formattedValue = '$' + Math.round(Math.abs(value)).toLocaleString();
                            
                            if (value < 0) {
                                cell.innerHTML = '<span class="negative">-' + formattedValue + '</span>';
                            } else if (value > 0) {
                                cell.innerHTML = '<span class="positive">' + formattedValue + '</span>';
                            } else {
                                cell.innerHTML = '$0';
                            }
                        }
                    });
                });
            });
        }
        
        
        // Accordion functionality
        function initializeAccordions() {
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            
            accordionHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    const content = document.getElementById(target);
                    const isActive = this.classList.contains('active');
                    
                    // Close all accordions first
                    accordionHeaders.forEach(h => {
                        h.classList.remove('active');
                        const targetId = h.getAttribute('data-target');
                        const targetContent = document.getElementById(targetId);
                        if (targetContent) {
                            targetContent.classList.remove('expanded');
                        }
                    });
                    
                    // Open clicked accordion (unless it was already active)
                    if (!isActive) {
                        this.classList.add('active');
                        if (content) {
                            content.classList.add('expanded');
                        }
                    }
                });
            });
            
            // Close all accordions by default
            accordionHeaders.forEach(header => {
                header.classList.remove('active');
                const targetId = header.getAttribute('data-target');
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.classList.remove('expanded');
                }
            });
        }
        
        // Create Put Exposure pie chart by expiration date
        function createPutExposurePieChart() {
            console.log('Creating Put Exposure pie chart...');
            const ctx = document.getElementById('putExposurePieChart');
            if (!ctx) {
                console.error('Cannot find putExposurePieChart canvas element');
                return;
            }
            
            const context = ctx.getContext('2d');
            
            // Collect put exposure data by expiration date
            const putExposureByExpiration = {};
            const accordionGroups = document.querySelectorAll('.accordion-group');
            
            accordionGroups.forEach(group => {
                const header = group.querySelector('.accordion-header');
                const expirationText = header.querySelector('.expiration-section').textContent;
                const table = group.querySelector('.financial-table tbody');
                
                // Extract expiration date
                const expirationMatch = expirationText.match(/Expiration: (\d{2}\/\d{2}\/\d{4})/);
                if (expirationMatch && table) {
                    const expirationDateStr = expirationMatch[1];
                    let putExposure = 0;
                    
                    // Process each position row in this expiration group
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 4) {
                            const typeText = cells[1].textContent.trim();
                            const type = typeText === 'P' ? 'Put' : typeText === 'C' ? 'Call' : typeText;
                            
                            if (type === 'Put') {
                                const strike = parseFloat(cells[2].textContent.replace('$', ''));
                                const quantity = parseInt(cells[3].textContent.trim());
                                
                                if (!isNaN(strike) && !isNaN(quantity)) {
                                    putExposure += strike * quantity * 100;
                                }
                            }
                        }
                    });
                    
                    if (putExposure > 0) {
                        putExposureByExpiration[expirationDateStr] = putExposure;
                    }
                }
            });
            
            // Prepare data for pie chart
            const labels = Object.keys(putExposureByExpiration).sort((a, b) => new Date(a) - new Date(b));
            const data = labels.map(label => putExposureByExpiration[label]);
            
            // Generate colors for each slice
            const colors = [
                '#3498db', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#95a5a6', '#2ecc71'
            ];
            
            window.putExposureChart = new Chart(context, {
                plugins: [ChartDataLabels],
                type: 'bar',
                data: {
                    labels: labels.map(label => {
                        // Format date to show month/day only
                        const date = new Date(label);
                        return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
                    }),
                    datasets: [{
                        data: data,
                        backgroundColor: '#3498db',
                        borderColor: '#3498db',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `Put Exposure: $${value.toLocaleString()}`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            anchor: 'end',
                            align: 'top',
                            color: '#ffffff',
                            font: {
                                size: 9,
                                weight: 'bold'
                            },
                            formatter: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                color: '#3a3a3a'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: '#3a3a3a'
                            }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const clickedDateStr = Object.keys(putExposureByExpiration)[dataIndex];
                            
                            // Format the date to match the accordion target format
                            const targetId = `exp-${clickedDateStr.replace(/\//g, '-')}`;
                            
                            console.log('Clicked bar for date:', clickedDateStr, 'Target ID:', targetId);
                            
                            // Find and open the corresponding accordion
                            const targetAccordion = document.getElementById(targetId);
                            const targetHeader = document.querySelector(`[data-target="${targetId}"]`);
                            
                            if (targetAccordion && targetHeader) {
                                // Close all other accordions first
                                const allHeaders = document.querySelectorAll('.accordion-header');
                                allHeaders.forEach(header => {
                                    header.classList.remove('active');
                                    const target = header.getAttribute('data-target');
                                    const content = document.getElementById(target);
                                    if (content) {
                                        content.classList.remove('expanded');
                                    }
                                });
                                
                                // Open the target accordion
                                targetHeader.classList.add('active');
                                targetAccordion.classList.add('expanded');
                                
                                // Scroll to the accordion
                                targetHeader.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center'
                                });
                                
                                console.log('Opened accordion for expiration:', clickedDateStr);
                            } else {
                                console.log('Could not find accordion elements for:', targetId);
                            }
                        }
                    }
                }
            });
        }

        // Create bubble chart for profit by expiration date
        function createExpirationScatterChart() {
            console.log('Creating profit by expiration bubble chart...');
            const ctx = document.getElementById('expirationScatterChart');
            if (!ctx) {
                console.error('Cannot find expirationScatterChart canvas element');
                return;
            }
            console.log('Found canvas element:', ctx);
            const context = ctx.getContext('2d');
            
            // Prepare data from each individual option position
            const scatterData = [];
            
            // Extract position data from tables in each accordion
            const accordionGroups = document.querySelectorAll('.accordion-group');
            console.log('Found', accordionGroups.length, 'accordion groups');
            
            accordionGroups.forEach(group => {
                const header = group.querySelector('.accordion-header');
                const expirationText = header.querySelector('.expiration-section').textContent;
                const table = group.querySelector('.financial-table tbody');
                
                // Extract expiration date
                const expirationMatch = expirationText.match(/Expiration: (\d{2}\/\d{2}\/\d{4})/);
                if (expirationMatch && table) {
                    const expirationDate = new Date(expirationMatch[1]);
                    
                    // Process each position row in this expiration group
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 6) {
                            // Extract: Symbol, Type, Strike, Quantity, Nominal, Total Profit
                            const symbol = cells[0].textContent.trim();
                            const typeText = cells[1].textContent.trim();
                            const type = typeText === 'P' ? 'Put' : typeText === 'C' ? 'Call' : typeText;
                            const strike = parseFloat(cells[2].textContent.replace('$', ''));
                            const quantity = parseInt(cells[3].textContent.trim());
                            const totalProfitText = cells[5].textContent.trim();
                            const totalProfit = parseFloat(totalProfitText.replace('$', ''));
                            
                            if (!isNaN(totalProfit) && !isNaN(quantity)) {
                                // Calculate nominal value (risk exposure)
                                const nominalValue = strike * quantity * 100;
                                
                                // Apply risk scaling: Puts 50% higher than Calls
                                const riskScaledValue = type === 'Put' ? nominalValue * 1.5 : nominalValue;
                                
                                // Scale radius from nominal value range $1000-$50000 to radius 4-20px
                                const minNominal = 1000;
                                const maxNominal = 50000;
                                const minRadius = 4;
                                const maxRadius = 20;
                                const scaledRadius = Math.max(minRadius, Math.min(maxRadius, 
                                    minRadius + (riskScaledValue - minNominal) * (maxRadius - minRadius) / (maxNominal - minNominal)
                                ));
                                
                                scatterData.push({
                                    x: expirationDate,
                                    y: totalProfit,
                                    r: scaledRadius, // Bubble radius based on nominal risk value
                                    symbol: symbol,
                                    type: type,
                                    strike: strike,
                                    quantity: quantity,
                                    nominalValue: nominalValue,
                                    riskScaledValue: riskScaledValue,
                                    totalProfitValue: totalProfit
                                });
                                
                                console.log(`Added: ${symbol} ${type} $${strike} x${quantity} = $${totalProfit.toFixed(0)} on ${expirationMatch[1]}`);
                            }
                        }
                    });
                }
            });
            
            // Sort by date
            scatterData.sort((a, b) => a.x - b.x);
            console.log('Total scatter points:', scatterData.length);
            
            // Daily sum calculation removed - now displayed in accordion headers
            
            // Store chart instance globally for resizing
            window.expirationChart = new Chart(context, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Individual Options',
                        data: scatterData,
                        backgroundColor: function(ctx) {
                            // Color points by option type: blue for puts, green for calls
                            const point = scatterData[ctx.dataIndex];
                            if (point && point.type) {
                                return point.type.toLowerCase().includes('put') ? '#3498db' : '#27ae60';
                            }
                            return '#3498db';
                        },
                        borderColor: function(ctx) {
                            const point = scatterData[ctx.dataIndex];
                            if (point && point.type) {
                                return point.type.toLowerCase().includes('put') ? '#3498db' : '#27ae60';
                            }
                            return '#3498db';
                        },
                        pointRadius: function(ctx) {
                            // Use the 'r' property from data for dynamic bubble sizing
                            const point = scatterData[ctx.dataIndex];
                            return point ? point.r : 8;
                        },
                        pointHoverRadius: function(ctx) {
                            // Increase hover radius proportionally
                            const point = scatterData[ctx.dataIndex];
                            return point ? point.r + 4 : 12;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#ffffff',
                                font: {
                                    size: 12
                                },
                                usePointStyle: true,
                                generateLabels: function(chart) {
                                    return [
                                        {
                                            text: 'Put Options',
                                            fillStyle: '#3498db',
                                            strokeStyle: '#3498db',
                                            fontColor: '#ffffff',
                                            pointStyle: 'circle',
                                            rotation: 0
                                        },
                                        {
                                            text: 'Call Options',
                                            fillStyle: '#27ae60',
                                            strokeStyle: '#27ae60',
                                            fontColor: '#ffffff',
                                            pointStyle: 'circle',
                                            rotation: 0
                                        }
                                    ];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Individual option point
                                    const point = scatterData[context[0].dataIndex];
                                    return point.symbol + ' ' + point.type + ' $' + point.strike;
                                },
                                label: function(context) {
                                    // Individual option point
                                    const point = scatterData[context.dataIndex];
                                    return [
                                        'Contracts: ' + point.quantity,
                                        'Nominal Value: $' + point.nominalValue.toLocaleString(),
                                        'Risk Value: $' + point.riskScaledValue.toLocaleString() + ' (bubble size)',
                                        'Total Profit: $' + point.y.toLocaleString()
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Expiration Date',
                                color: '#e0e0e0',
                                font: {
                                    size: 16
                                }
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 14
                                }
                            },
                            grid: {
                                color: '#3a3a3a'
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Individual Option Profit ($) - Bubble Size = Risk Value',
                                color: '#e0e0e0',
                                font: {
                                    size: 14
                                }
                            },
                            ticks: {
                                color: '#a0a0a0',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: '#3a3a3a'
                            }
                        }
                    },
                    interaction: {
                        intersect: true,
                        mode: 'nearest'
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0) {
                            const dataIndex = elements[0].index;
                            const clickedPoint = scatterData[dataIndex];
                            
                            if (clickedPoint && clickedPoint.x) {
                                // Format the date to match the accordion target format
                                const expirationDate = new Date(clickedPoint.x);
                                const dateStr = expirationDate.toLocaleDateString('en-US', {
                                    month: '2-digit',
                                    day: '2-digit', 
                                    year: 'numeric'
                                });
                                const targetId = `exp-${dateStr.replace(/\//g, '-')}`;
                                
                                console.log('Clicked point expiration:', dateStr, 'Target ID:', targetId);
                                
                                // Find and open the corresponding accordion
                                const targetAccordion = document.getElementById(targetId);
                                const targetHeader = document.querySelector(`[data-target="${targetId}"]`);
                                
                                if (targetAccordion && targetHeader) {
                                    // Close all other accordions first
                                    const allHeaders = document.querySelectorAll('.accordion-header');
                                    allHeaders.forEach(header => {
                                        header.classList.remove('active');
                                        const target = header.getAttribute('data-target');
                                        const content = document.getElementById(target);
                                        if (content) {
                                            content.classList.remove('expanded');
                                        }
                                    });
                                    
                                    // Open the target accordion
                                    targetHeader.classList.add('active');
                                    targetAccordion.classList.add('expanded');
                                    
                                    // Scroll to the accordion
                                    targetHeader.scrollIntoView({
                                        behavior: 'smooth',
                                        block: 'center'
                                    });
                                    
                                    console.log('Opened accordion for expiration:', dateStr);
                                } else {
                                    console.log('Could not find accordion elements for:', targetId);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Apply coloring and initialize accordions when page loads
        document.addEventListener('DOMContentLoaded', function() {
            applyOptionsTableColoring();
            initializeAccordions();
            
            // Create both charts after everything is initialized
            setTimeout(() => {
                createExpirationScatterChart();
                createPutExposurePieChart();
            }, 100);
        });
        
        // Also apply immediately in case DOMContentLoaded already fired
        applyOptionsTableColoring();

        // Function to scroll to and highlight symbol in sidebar navigation
        function scrollToSymbolInNav(symbolName) {
            // Find the symbol link in the sidebar
            const symbolNavItem = document.querySelector(`.symbol-nav-item[href="/symbol/${symbolName}"]`);
            if (symbolNavItem) {
                // Ensure symbols section is expanded
                const symbolsToggle = document.getElementById('symbolsToggle');
                const symbolsList = document.getElementById('symbolsList');
                if (!symbolsToggle.classList.contains('expanded')) {
                    symbolsToggle.classList.add('expanded');
                    symbolsList.classList.add('expanded');
                }
                
                // Remove any existing highlight
                document.querySelectorAll('.symbol-nav-item.highlighted').forEach(item => {
                    item.classList.remove('highlighted');
                });
                
                // Add highlight to target symbol
                symbolNavItem.classList.add('highlighted');
                
                // Scroll to the symbol in the sidebar
                symbolNavItem.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                
                // Remove highlight after 2 seconds
                setTimeout(() => {
                    symbolNavItem.classList.remove('highlighted');
                }, 2000);
            }
        }
        
        // Add click handler for symbol links in main content
        document.addEventListener('click', function(e) {
            const symbolLink = e.target.closest('.symbol-link');
            if (symbolLink) {
                // Extract symbol from the link text
                const symbolName = symbolLink.textContent.trim();
                // Don't prevent default - still want to navigate
                // Just add the scroll animation before navigation
                scrollToSymbolInNav(symbolName);
            }
        });


        console.log('Options page loaded');
    </script>
    <script src="/static/js/navigation.js"></script>
    <script src="/static/js/symbol-modal.js"></script>
    <script src="/static/js/table-sort.js"></script>
</body>
</html>